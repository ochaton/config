version: "3"

x-etcd: &etcd
  image: quay.io/coreos/etcd:v2.3.8
  container_name: etcd
  networks:
    - tarantool
  environment:
    ETCD_LISTEN_PEER_URLS: http://0.0.0.0:2380
    ETCD_LISTEN_CLIENT_URLS: http://0.0.0.0:2379
    ETCDCTL_API: 2
    ETCD_INITIAL_CLUSTER_TOKEN: etcd-cluster
    ETCD_INITIAL_CLUSTER: etcd=http://etcd:2380
    ETCD_NAME: etcd
    ETCD_ADVERTISE_CLIENT_URLS: http://etcd:2379
    ETCD_INITIAL_ADVERTISE_PEER_URLS: http://etcd:2380

x-tt: &tt
  build: .
  volumes:
    - $PWD/../:/opt/tarantool/.rocks/share/tarantool:ro
    - $PWD/app:/opt/tarantool
    - $PWD/net:/opt/tarantool/net:ro
  depends_on:
    etcd:
      condition: service_started
  privileged: true
  networks:
    - tarantool
  command: ["/bin/sh", "-c", "sleep 5 && tarantool /opt/tarantool/init.lua"]

networks:
  tarantool:
    name: tt_net
    driver: bridge

services:
  etcd:
    <<: *etcd
  etcd_load:
    image: registry.gitlab.com/ochaton/switchover:010a6965
    networks:
      - tarantool
    volumes:
      - $PWD/instance.etcd.yaml:/instance.etcd.yaml:ro
    depends_on:
      etcd:
        condition: service_started
    entrypoint: ['']
    command: ["/bin/sh", "-c", "sleep 3 && switchover -v -e http://etcd:2379 etcd load / /instance.etcd.yaml"]
  instance_01:
    <<: *tt
    container_name: instance_01
    environment:
      TT_INSTANCE_NAME: instance_01
  instance_02:
    <<: *tt
    container_name: instance_02
    environment:
      TT_INSTANCE_NAME: instance_02
