version: "3"

x-etcd: &etcd
  image: quay.io/coreos/etcd:v2.3.8
  container_name: etcd
  networks:
    - tarantool
  environment:
    ETCD_LISTEN_PEER_URLS: http://0.0.0.0:2380
    ETCD_LISTEN_CLIENT_URLS: http://0.0.0.0:2379
    ETCDCTL_API: 2
    ETCD_INITIAL_CLUSTER_TOKEN: etcd-cluster
    ETCD_INITIAL_CLUSTER: etcd=http://etcd:2380
    ETCD_NAME: etcd
    ETCD_ADVERTISE_CLIENT_URLS: http://etcd:2379
    ETCD_INITIAL_ADVERTISE_PEER_URLS: http://etcd:2380

networks:
  tarantool:
    name: tt_net
    driver: bridge

services:
  etcd:
    <<: *etcd
  etcd_load:
    image: registry.gitlab.com/ochaton/switchover:latest
    networks:
      - tarantool
    volumes:
      - $PWD/instance.etcd.yaml:/instance.etcd.yaml:ro
    depends_on:
      etcd:
        condition: service_started
    entrypoint: ['']
    command: ["/bin/sh", "-c", "sleep 3 && switchover -v -e http://etcd:2379 etcd load / /instance.etcd.yaml"]
  instance_001:
    image: tarantool/tarantool:2.10
    container_name: instance_001
    volumes:
      - $PWD/../:/opt/tarantool/.rocks/share/tarantool:ro
      - $PWD/app:/opt/tarantool
    depends_on:
      etcd:
        condition: service_started
    networks:
      - tarantool
    command: ["/bin/sh", "-c", "sleep 8 && tarantool /opt/tarantool/init.lua"]
